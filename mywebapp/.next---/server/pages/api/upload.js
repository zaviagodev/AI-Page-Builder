"use strict";(()=>{var e={};e.id=5039,e.ids=[5039],e.modules={1841:e=>{e.exports=require("@aws-sdk/client-s3")},614:e=>{e.exports=require("next-auth/jwt")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7441:e=>{e.exports=require("sharp")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},1053:(e,t,s)=>{s.r(t),s.d(t,{config:()=>E,default:()=>j,routeModule:()=>_});var r={};s.r(r),s.d(r,{config:()=>h,default:()=>handler});var i=s(1802),n=s(7153),a=s(6249),o=s(614),u=s(7147),l=s.n(u),p=s(1017),f=s.n(p);let d=require("formidable-serverless");var c=s.n(d),m=s(1841),g=s(747),w=s(7441),S=s.n(w);let h={api:{bodyParser:!1}};async function handler(e,t){let s=await (0,o.getToken)({req:e});if(!s){t.status(200).json({ok:!0,status:401,error:"Not authenticated!"});return}let r=s.name;if("POST"===e.method){let s=new(c()).IncomingForm;s.parse(e,async(e,s,i)=>{if(e)return t.status(500).json({ok:!0,status:500,error:"Something went wrong."});let n=f().extname(i.file.name).toLowerCase();if(".jpeg"!==n&&".jpg"!==n&&".png"!==n&&".gif"!==n&&".ico"!==n&&".webp"!==n&&".webm"!==n&&".mp4"!==n&&".mp3"!==n){t.status(500).json({ok:!0,status:500,error:"File type not allowed."});return}let a=l().readFileSync(i.file.path),o=new Date().toLocaleDateString("en-CA",{year:"numeric",month:"2-digit",day:"2-digit"});if(process.env.SPACES_URL){let e=a;(".jpeg"===n||".jpg"===n)&&(e=await S()(i.file.path).resize(1920,1920,{fit:S().fit.inside,withoutEnlargement:!0}).jpeg({quality:70,progressive:!0,force:!1}).toBuffer());let s={Bucket:process.env.SPACES_BUCKET,ACL:"public-read",Key:`${r}/${o}/${i.file.name}`,Body:e,ContentType:i.file.type};try{if(await g.S.send(new m.PutObjectCommand(s)),".jpeg"===n||".jpg"===n||".png"===n||".gif"===n||".webp"===n||".webm"===n){let e=await S()(i.file.path).resize(100,100,{fit:S().fit.inside,withoutEnlargement:!0}).toBuffer();await g.S.send(new m.PutObjectCommand({Bucket:process.env.SPACES_BUCKET,ACL:"public-read",Key:`${r}/${o}/thumbs/${i.file.name}`,Body:e,ContentType:i.file.type}))}t.status(200).json({ok:!0,status:200,url:process.env.SPACES_URL+"/"+r+"/"+o+"/"+i.file.name})}catch(e){t.status(500).json({ok:!0,status:500,error:"Something went wrong."})}}else{let e=f().join(process.env.WEB_ASSETS_PATH,"uploads/"+r);l().existsSync(`${e}/${o}/thumbs`)||l().mkdirSync(`${e}/${o}/thumbs`,{recursive:!0});let s=a;(".jpeg"===n||".jpg"===n)&&(s=await S()(i.file.path).resize(1920,1920,{fit:S().fit.inside,withoutEnlargement:!0}).jpeg({quality:80,progressive:!0,force:!1}).toBuffer()),l().writeFile(`${e}/${o}/${i.file.name}`,s,async s=>{if(s){t.status(500).json({ok:!0,status:500,error:"Something went wrong."});return}if(".jpeg"===n||".jpg"===n||".png"===n||".gif"===n||".webp"===n||".webm"===n){let s=await S()(i.file.path).resize(100,100,{fit:S().fit.inside,withoutEnlargement:!0}).toBuffer();l().writeFile(`${e}/${o}/thumbs/${i.file.name}`,s,e=>{if(e){t.status(500).json({ok:!0,status:500,error:"Something went wrong."});return}t.status(200).json({ok:!0,status:200,url:process.env.WEB_ASSETS_URL+"/uploads/"+r+"/"+o+"/"+i.file.name})})}else t.status(200).json({ok:!0,status:200,url:process.env.WEB_ASSETS_URL+"/uploads/"+r+"/"+o+"/"+i.file.name})})}})}}let j=(0,a.l)(r,"default"),E=(0,a.l)(r,"config"),_=new i.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/upload",pathname:"/api/upload",bundlePath:"",filename:""},userland:r})},747:(e,t,s)=>{s.d(t,{S:()=>i});var r=s(1841);let i=new r.S3({endpoint:process.env.SPACES_ENDPOINT,region:"us-east-1",credentials:{accessKeyId:process.env.SPACES_KEY,secretAccessKey:process.env.SPACES_SECRET}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),s=t.X(0,[4222],()=>__webpack_exec__(1053));module.exports=s})();