"use strict";(()=>{var e={};e.id=4181,e.ids=[4181],e.modules={1841:e=>{e.exports=require("@aws-sdk/client-s3")},614:e=>{e.exports=require("next-auth/jwt")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7441:e=>{e.exports=require("sharp")},9648:e=>{e.exports=import("axios")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},5578:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{config:()=>d,default:()=>c,routeModule:()=>p});var a=r(1802),n=r(7153),i=r(6249),o=r(6231),u=e([o]);o=(u.then?(await u)():u)[0];let c=(0,i.l)(o,"default"),d=(0,i.l)(o,"config"),p=new a.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/texttoimage",pathname:"/api/texttoimage",bundlePath:"",filename:""},userland:o});s()}catch(e){s(e)}})},6231:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{default:()=>g});var a=r(614),n=r(7147),i=r.n(n),o=r(1017),u=r.n(o),c=r(9648),d=r(1841),p=r(747),l=r(7441),m=r.n(l),f=e([c]);async function handler(e,t){let r=await (0,a.getToken)({req:e});if(!r){t.status(200).json({ok:!0,status:401,error:"Not authenticated!"});return}let s=r.name;if("POST"!==e.method)return;let{prompt:n,negative_prompt:o,model:l,width:f,height:g,steps:S,guidance:h,seed:w,scheduler:_,output_format:v,folder_path:y}=e.body,E=process.env.GETIMG_API_KEY,b=JSON.stringify({model:l||"realistic-vision-v3",prompt:n,negative_prompt:o,width:f||512,height:g||512,steps:S||75,guidance:h||9,scheduler:_||"dpmsolver++",output_format:v||"jpeg"}),x={headers:{Authorization:`Bearer ${E}`,"Content-Type":"application/json"}},A=await c.default.post("https://api.getimg.ai/v1/stable-diffusion/text-to-image",b,x);if(A.data.error)t.status(200).json({ok:!0,status:500,error:"Something went wrong."});else{let e=new Date().toLocaleDateString("en-CA",{year:"numeric",month:"2-digit",day:"2-digit"}),r=A.data.image,a="image/jpeg",n=new Buffer.from(r.replace(/^data:image\/\w+;base64,/,""),"base64"),o=function(e){let t=function(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="";for(let e=0;e<5;e++){let e=Math.floor(Math.random()*t.length);r+=t.charAt(e)}return r}(0);return e?`ai-${t}-${e}`:`ai-${t}`}()+".jpg";if(!process.env.SPACES_URL)return new Promise((a,n)=>{let c=u().join(process.env.WEB_ASSETS_PATH,"uploads/"+s+"/"+e);i().existsSync(c)||i().mkdirSync(c,{recursive:!0}),i().existsSync(c+"/thumbs")||i().mkdirSync(c+"/thumbs",{recursive:!0}),i().writeFile(c+"/"+o,r,"base64",async n=>{if(n){t.status(500).json({ok:!0,status:500,error:"Something went wrong."}),a();return}let u=new Buffer.from(r,"base64"),d=await m()(u).resize(100,100,{fit:m().fit.inside,withoutEnlargement:!0}).toBuffer();i().writeFile(c+"/thumbs/"+o,d,"base64",r=>{if(r){t.status(500).json({ok:!0,status:500,error:"Something went wrong."}),a();return}let n=process.env.WEB_ASSETS_URL+"/uploads/"+s+"/"+e+"/"+o;t.status(200).json({ok:!0,status:200,url:n}),a()})})});{let i={Bucket:process.env.SPACES_BUCKET,ACL:"public-read",Key:`${s}/${e}/${o}`,Body:n,ContentEncoding:"base64",ContentType:a};try{await p.S.send(new d.PutObjectCommand(i));let n=new Buffer.from(r,"base64"),u=await m()(n).resize(100,100,{fit:m().fit.inside,withoutEnlargement:!0}).toBuffer();await p.S.send(new d.PutObjectCommand({Bucket:process.env.SPACES_BUCKET,ACL:"public-read",Key:`${s}/${e}/thumbs/${o}`,Body:u,ContentType:a})),t.status(200).json({ok:!0,status:200,url:process.env.SPACES_URL+"/"+s+"/"+e+"/"+o})}catch(e){t.status(500).json({ok:!0,status:500,error:"Something went wrong."})}}}}c=(f.then?(await f)():f)[0];let g=handler;s()}catch(e){s(e)}})},747:(e,t,r)=>{r.d(t,{S:()=>a});var s=r(1841);let a=new s.S3({endpoint:process.env.SPACES_ENDPOINT,region:"us-east-1",credentials:{accessKeyId:process.env.SPACES_KEY,secretAccessKey:process.env.SPACES_SECRET}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[4222],()=>__webpack_exec__(5578));module.exports=r})();